---
layout: '../../../layouts/MarkdownPost.astro'
title: 腾讯游戏学院 | C++代码规范
pubDate: 2021-10-17
description: '光子工作室的 C++代码规范'
author: 'Insyent居无何'
cover:
    url: 'https://oss.insyent.today/3.jpg'
    square: 'https://oss.insyent.today/3.jpg'
    alt: 'cover'
tags: ["游戏开发", "客户端", "UnrealEngine"]
theme: 'light'
featured: ture
---

# 0 目录

- UE4 C++代码规范
- 如何编写符合规范的代码
- [UE4蓝图规范](#UE4蓝图规范)
- 参考文档

# 1 UE4 C++代码规范

## 1.1 命名规范

- **每个单词**首字母大写(大驼峰式)
- 类型名称前面须有标识类型前缀

| 开头字母 |   表示含义    |         示例         |
| :------: | :-----------: | :------------------: |
|    T     |    模板类     |         TMap         |
|    U     | 继承自UObject | UMoviePlayerSettings |
|    A     | 继承自AActor  | APlayerCameraManager |
|    S     | 继承自SWidget |   SCompoundWidget    |
|    I     |  抽象接口类   |  INavNodeInterface   |
|    E     |     枚举      |     EAccountType     |
|    b     |   布尔变量    |      bHasFadeIn      |
|    F     |    其他类     |       FVector        |

- 类型和变量名一般是名词，如FVector
- 函数或方法名使用动词描述，如GetSize()
- 返回值为布尔值的函数，命名时最好采用Is或Should

## 1.2 数据类型

- 字符串类最好使用UE封装好的FString、FText等

- 容器类使用UE已定义的类，如TArray、TMap等

  > 因为UE有自己的内存池与内存池管理机制

- 文件相关操作使用UE封装好的类，如FFileManagerGeneric，如果需要序列化操作，则可以使用FArchive

## 1.3 注释

- 编写有意义的注释
- 不要给可读性不好的代码添加注释，而是要重写这段代码
- 编写的注释不要和代码相冲突
- **UE4支持基于JavaDoc规则**

## 1.4 代码格式

- 大括号建议另起一行

- if-else每一个代码块都必须位于大括号内
- switch语句中使用注释//fallss through 表示继续向下执行
- Tab缩进大小为4个字符
- 不要在全局作用域内使用"using"声明命名空间
- 可以在一个命名空间内或函数体内使用"using"声明命名空间

## 1.5 文件依赖

- 所有头文件都应该使用#pragma 来避免多次包含
- 如果可以使用前向声明Forward Declarations来代替包含头文件，就使用前向声明
- 包含头文件时尽量具体
-  谨慎使用inline关键字定义函数
- 不要大量使用inline函数，因为会导致强制重编译。应当只用在一些不重要的访问函数，并且性能测试验证是有收益的场景
- 模块通常包括Public和Private目录

## 1.6 封装

- 必须使用访问修饰符

## 1.7 C++11与现代语言语法

- static_assert，可以用于**编译时断言**
- 大部分情况应该使用nullptr，而不是NULL。nullptr实际上是托管的空引用类型
- auto关键字
  - Lambda表达式和变量绑定时
  - 迭代器变量，但只能用在迭代器类型名很长，影响代码可读性时
  - 在模板代码中使用，尤其是当表达式的类型不太容易辨别的时候
- Lambda表达式长度不要过长，两三条语句就可以
- 以引用或值传递捕获变量时，如果Lambda不在被捕获的变量上下文中执行，那么可能导致无法引用
- 使用值传递捕捉，考虑性能问题，避免不必要的拷贝
- 规模较大的Lambda表达式或返回其他函数调用结果时，最好声明Lambda返回值类型。对于一般的Lambda表达式，自动捕捉和隐式的返回值类型都是可以接受的

- 如果在Lambda表达式中引用了成员变量，那么会隐式的自动捕捉this对象指针，即使是[=]也是如此
- 建议用Enum Class代替旧式枚举
- UPROPERTY类型定义也是一样，只要是uint8类型都可以代替TEnumAsByte<>定义
- 用作标志位定义的枚举类可以使用一个新的宏ENUM_CLASS_FLAGS(EnumType)来自动定义位操作
- 所有标志枚举类型都应有"None"，值为0

-  更建议使用using关键字声明别名
- 默认成员初始化，用于在类内部定义成员变量的默认值
  - 好处
    - 在不同的构造函数中不需要重复编写初始化代码
    - 初始化顺序和声明顺序不会混淆
    - 成员类型、属性标志和默认值都在同一处，有利于可读性和可维护性
  - 缺点
    - 任何对默认值的修改都会导致重新编译所有引用文件
    - 头文件的修改是无法在引擎的Patch版本中做到的，所以这种风格有可能会限制原本可以Patch修复的一些场景
    - 有些对象是无法用这种方式初始化的，例如基类、UObject的子对象、前向类型声明的指针、来源于构造函数参数的值以及需要多个步骤进行初始化的成员
    - 如果是把一些初始化放到头文件中，剩下的一部分放到.cpp文件的构造函数中，反而会降低代码的可读性和维护性

- 引擎中的第三方代码应该使用容易搜索的注释标签 @third party code
- 修改引擎中某个库的代码时，确保在修改处增加修改注释//@UE4与修改原因

## 1.8 一般风格

- 类的构造函数中初始化成员变量的顺序最好与类中声明成员变量的顺序一致，否则有可能导致编译器警告
- 减少变量的依赖距离，即把**变量的声明和定义放在第一次使用的地方**。可以在代码段的最前面初始化变量，但是不要等到几百行之后再去使用
- **尽量解决所有的编译器警告**，一般而言，编译器警告都表示该处代码可能会存在问题，需要仔细确认在文件结尾留一行空行，所有的.cpp和.h文件都应该留一行空行以便于更好的兼容gcc编译器
- 请不要提交调试代码，将调试代码和其他代码混在一起会让代码可读性变差
- 确保对字符串变量使用TEXT()宏。如果没有使用，那么对于从字符串构造FString的代码会产生不必要的转码处理
- 指针和引用的声明应当只有一个空格，位于指针或引用符号的右边。这样做的好处是很容易就可以在代码中查找某种类型的指针或引用
- 禁止使用Shadowed Variable
- 不要在代码中硬编码字符串
- 如果希望一直持有UObject对象，则必须添加UPROPERTY标记，让UE引擎能够正确标识引用，不至于该UObject被GC回收
- 对于UE引擎中的字符编码转换系列宏，必须只能用作函数参数使用不能将结果赋值给其他对象，否则会由于临时变量被释放导致不可预知的问题
  - TCHAR_TO_ANSI
  - ANSI_TO_TCHAR
  - TCHAR_TO_WCHAR
  - WCHAR_TO_TCHAR
  - TCHAR_TO_UTF8
  - UTF8_TO_TCHAR

# 2 如何编写符合规范的代码

- 基础：熟悉规范
- 提升：多读现有规范的代码
- 实践：分析解决不符合规范的代码Bug，按照规范编码
- 辅助：静态代码分析扫描工具，CppLint(自定义UE4规则)，PVS Studio，KIocwork

# 3 UE4 蓝图规范

## 3.1 编译

- 所有蓝图应该在零warning零error情况下运行
- 不要提交损坏的蓝图(broken blueprints)

## 3.2 变量

- 所有非布尔变量名都必须是清晰、无歧义和描述性的名词
- 大驼峰式命名
- 布尔变量名使用前缀`b`
- 布尔变量名中尽可能命名为描述形容词，例如`bDead`而非`bIsDead`，`Is`是为函数命名使用的
- 复杂状态不要使用布尔变量，而是使用枚举
- 为了配置蓝图的行为而可以安全地更改 的值的所有变量都应标记为`Editable`
- 所有函数和事件都执行某种形式的操作，都应以动词开头
- 编写一个不改变或修改任何对象的状态并且纯粹是为了获取信息、状态或计算是/否值的函数时，它应该提出一个问题，如`IsDead`
- 任何处理事件或分派事件的函数都应该以`On`开头，例如`OnClick`
- 所有函数都应有返回节点
- 没有函数可以超过50个节点，任何这么大的功能都应该分解成更小的功能，以提高可读性和易于维护

## 3.3 事件图表

- 对齐线而非节点
- 在适当的地方处理转换错误
- 不应有任何悬空/死节点

# 4 参考文档

- [UE官方文档](https://docs.unrealengine.com/4.27/zh-CN/ProductionPipelines/DevelopmentSetup/CodingStandard/)
- [蓝图规范](https://github.com/Allar/ue5-style-guide)
